{% extends "admin/layout.html" %}


{% block style %}
<style>
    .bootstrap-tagsinput {
        width: 100%;
        height: 200px;
        padding: 10px;
        line-height: 40px;
        overflow-y: scroll;
    }

    .bootstrap-tagsinput .tag {
        color: white;
        display: inline-block;
        background: #1D375F;
        padding-left: 10px;
        padding-right: 10px;
        padding-bottom: 2px;
        line-height: 40px;
        margin: 2px;
    }
</style>
{% endblock %}

{% block contents %}
<div class="card">
    <div class="card-body">
        
        <div class="form-group row">
            <div class="col-lg-12">
                <b>계정 정보</b>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">이메일(아이디)</label>
            <div class="col-lg-9">
                <input class="form-control" type="text" id="user_id" name="user_id" value="{{user_id}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">비밀번호</label>
            <div class="col-lg-9">
                <input class="form-control" type="password" id="user_pw" name="user_pw" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">비밀번호 확인</label>
            <div class="col-lg-9">
                <input class="form-control" type="password" id="user_pw_ok" name="user_pw_ok" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-3 col-form-label form-control-label">업체명</label>
            <div class="col-md-9">
                <input class="form-control" type="text" id="name" name="name" value="{{name}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">업체 연락처</label>
            <div class="col-lg-9">
                <input class="form-control" type="phone" id="tel" name="tel" value="{{tel}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-3 col-form-label form-control-label">주소</label>
            <div class="col-md-9">
                <input class="form-control" type="text" id="address" name="address" value="{{address}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-3 col-form-label form-control-label">상세주소</label>
            <div class="col-md-9">
                <input class="form-control" type="text" id="address2" name="address2" value="{{address2}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">계정 유형</label>
            <div class="col-lg-9">
                <select class="form-control" id="user_type" name="user_type">
                    {% for k, v in user_types.items() %}
                    <option value="{{k}}">{{v}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-3 col-form-label form-control-label">이용 시작 날짜</label>
            <div class="col-md-9">
                <input class="form-control" type="date" id="started_at" name="started_at" value="{{started_at}}" placeholder="YYYY-MM_DD"/>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-3 col-form-label form-control-label">이용 종료 날짜</label>
            <div class="col-md-9">
                <input class="form-control" type="date" id="ended_at" name="ended_at" value="{{ended_at}}" placeholder="YYYY-MM_DD" />
            </div>
        </div>



        <div class="form-group row">
            <div class="col-lg-12" style="margin-top:40px;">
                <b>담당자 정보</b>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">담당자 이름</label>
            <div class="col-lg-9">
                <input class="form-control" type="text" id="manager_name" name="manager_name" value="{{manager_name}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">담당자 연락처</label>
            <div class="col-lg-9">
                <input class="form-control" type="phone" id="manager_tel" name="manager_tel" value="{{manager_tel}}" />
            </div>
        </div>


        <div class="form-group row">
            <div class="col-lg-12" style="margin-top:40px;">
                <b>나의 호텔 지정</b>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">호텔</label>
            <div class="col-lg-9">
                <select class="selectize" id="hotel_id" name="hotel_id">
                    {% for k, v in hotels.items() %}
                    <option value="{{k}}">{{v}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>


        <div class="form-group row">
            <div class="col-lg-12" style="margin-top:40px;">
                <b>경쟁 호텔 지정</b>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">경쟁 호텔 추가</label>
            <div class="col-lg-8">
                <select class="selectize" id="competition_id">
                    {% for k, v in hotels.items() %}
                    <option value="{{k}}">{{v}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-lg-1">
                <button type="button" onclick="add_competition();" style="width: 100%;" class="btn btn-success">추가</button>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">경쟁 호텔 목록</label>
            <div class="col-lg-9">
                <input id="competitions" name="competitions" class="div-tag">
            </div>
        </div>


        <div class="form-group row">
            <div class="col-lg-12" style="margin-top:40px;">
                <b>크롤러 정책 지정</b>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">크롤러 정책</label>
            <div class="col-lg-9">
                <select class="form-control" id="rule_id" name="rule_id">
                    <option value="0">크롤러 정책 없음</option>
                    {% for k, v in crawler_rules.items() %}
                    <option value="{{k}}">{{v}}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-3 col-form-label form-control-label">경쟁호텔 이용 개수(최대)</label>
            <div class="col-md-9">
                <input class="form-control" type="number" id="hotel_limit" name="hotel_limit" value="{{hotel_limit}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-md-3 col-form-label form-control-label">OTA 이용 개수(최대)</label>
            <div class="col-md-9">
                <input class="form-control" type="number" id="ota_limit" name="ota_limit" value="{{ota_limit}}" />
            </div>
        </div>
        <div class="form-group row">
            <label class="col-lg-3 col-form-label form-control-label">OTA 모니터링 설정</label>
            <div class="col-lg-9">
            {% for ota_code in range(ota_code_to_str | length) %}
                <div style="width:120px;">
                {{ota_code_to_label[ota_code]}} <input type="checkbox" id="ota_{{ota_code}}">
                </div>
                {{'<br>' | safe if ota_code % 4 == 3 else ''}}
            {% endfor %}
            </div>
        </div>
        
        
        <div class="form-group row">
            <div class="col-lg-12" style="text-align: center;">
                <input type="button" class="btn btn-primary" value="생성" onclick="create_or_update_account();">
                <input type="button" class="btn btn-secondary" value="돌아가기" onclick="history.go(-1)">
            </div>
        </div>
        
    </div><!-- card body -->
</div> <!-- card-outline -->

{% endblock %}

{% block script %}

<script>
    function add_competition() {
        item = $("#competition_id");
        $('.div-tag').tagsinput('add', {id:item.val(), label:item.text()});
    }

    const ota_code_to_str = {{ ota_code_to_str | safe }}
    function create_or_update_account() {
        var otas = 0;
        var otas_order = [];
        var competition_list = $("#competitions").val() != '' ? $("#competitions").val().split(',') : []
        for (let ota_code in ota_code_to_str){
            console.log('$(`#ota_${ota_code}`).is(":checked"),',$(`#ota_${ota_code}`).is(":checked"))
            if ($(`#ota_${ota_code}`).is(":checked")) {
                otas |= 1 << ota_code;
                otas_order.push(parseInt(ota_code));
            }
        }

        if (parseInt($("#ota_limit").val()) < otas_order.length) return alert("최대 ota 개수를 확인해주세요.")
        if (parseInt($("#hotel_limit").val()) < competition_list.length) return alert("최대 경쟁호텔 개수를 확인해주세요.")

        params = {
            'user_id': $("#user_id").val(),
            'user_pw': $("#user_pw").val(),
            'user_pw_ok': $("#user_pw_ok").val(),
            'name': $("#name").val(),
            'tel': $("#tel").val(),
            'address': $("#address").val(),
            'address2': $("#address2").val(),
            'user_type': parseInt($("#user_type").val()),
            'manager_name': $("#manager_name").val(),
            'manager_tel': $("#manager_tel").val(),
            'hotel_id': $("#hotel_id").val() == '' ? '' : parseInt($("#hotel_id").val()),
            'competitions': competition_list,
            'rule_id': parseInt($("#rule_id").val()),
            'otas': otas,
            'otas_order': JSON.stringify(otas_order),
            'started_at': $("#started_at").val(),
            'ended_at': $("#ended_at").val(),
            'hotel_limit': parseInt($("#hotel_limit").val()),
            'ota_limit': parseInt($("#ota_limit").val()),
        };

        $.ajax({
            url: "/account/api/create_or_update",
            type: "post",
            accept: "application/json",
            contentType: "application/json; charset=utf-8",
            data: JSON.stringify(params),
            dataType: "json",
            success: function(data) {
                if (data.code != 200) {
                    alert(data.msg);
                    return;
                }
                alert("계정을 생성하였습니다.");
                location.href = '/account/list'
            },error: function(jqXHR,textStatus,errorThrown) {
                alert("호텔 내용 수정 실패");
            }
        });
    }

    $(document).ready(function () {
        $('.selectize').selectize({
            sortField: 'text'
        });
    });

    // 경쟁 호텔
    $('.div-tag').tagsinput({
        allowDuplicates: false,
        itemValue: 'id',
        itemText: 'label',
        freeInput: false
    });

    $('.bootstrap-tagsinput input').attr('readonly', true);
</script>

{% endblock %}
